<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khan Real Estate Agency CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- Configuration & Initialization ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'khan-crm-v1';

        // --- State Management ---
        let currentUser = null;
        let language = 'en';
        let activeSection = 'clients';

        const labels = {
            en: {
                login: "Sign In",
                dashboard: "Dashboard",
                clients: "Clients",
                sellers: "Sellers",
                buyers: "Buyers",
                agents: "Agents",
                properties: "Properties",
                followups: "Follow-Ups",
                commission: "Commission",
                logout: "Logout",
                addNew: "Add New",
                edit: "Edit",
                delete: "Delete",
                name: "Name",
                phone: "Phone",
                address: "Address",
                save: "Save",
                cancel: "Cancel",
                toggleLang: "Ø§Ø±Ø¯Ùˆ",
                loading: "Loading data...",
                noData: "No records found.",
                whatsapp: "WhatsApp",
                price: "Price",
                confirmDelete: "Are you sure you want to delete this record?"
            },
            ur: {
                login: "Ø³Ø§Ø¦Ù† Ø§Ù† Ú©Ø±ÛŒÚº",
                dashboard: "ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ",
                clients: "Ú©Ù„Ø§Ø¦Ù†Ù¹Ø³",
                sellers: "Ø¨ÛŒÚ†Ù†Û’ ÙˆØ§Ù„Û’",
                buyers: "Ø®Ø±ÛŒØ¯Ø§Ø±",
                agents: "Ø§ÛŒØ¬Ù†Ù¹Ø³",
                properties: "Ù¾Ø±Ø§Ù¾Ø±Ù¹ÛŒØ²",
                followups: "ÙØ§Ù„Ùˆ Ø§Ù¾",
                commission: "Ú©Ù…ÛŒØ´Ù†",
                logout: "Ù„Ø§Ú¯ Ø¢ÙˆÙ¹",
                addNew: "Ù†ÛŒØ§ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº",
                edit: "ØªØ±Ù…ÛŒÙ…",
                delete: "Ø­Ø°Ù Ú©Ø±ÛŒÚº",
                name: "Ù†Ø§Ù…",
                phone: "ÙÙˆÙ†",
                address: "Ù¾ØªÛ",
                save: "Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº",
                cancel: "Ù…Ù†Ø³ÙˆØ®",
                toggleLang: "English",
                loading: "ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’...",
                noData: "Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº Ù…Ù„Ø§Û”",
                whatsapp: "ÙˆØ§Ù¹Ø³ Ø§ÛŒÙ¾",
                price: "Ù‚ÛŒÙ…Øª",
                confirmDelete: "Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÛŒÛ Ø±ÛŒÚ©Ø§Ø±Úˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ"
            }
        };

        function t(key) { return labels[language][key] || key; }

        // --- UI Rendering ---
        const renderApp = () => {
            const root = document.getElementById('root');
            if (!currentUser) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                            <h1 class="text-3xl font-bold text-slate-800 mb-6">Khan CRM</h1>
                            <button id="authBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                                ${t('login')}
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('authBtn').onclick = handleAuth;
                return;
            }

            root.innerHTML = `
                <div class="flex flex-col md:flex-row min-h-screen bg-gray-100">
                    <!-- Sidebar -->
                    <aside class="w-full md:w-64 bg-slate-900 text-white flex flex-col">
                        <div class="p-6 text-2xl font-bold border-b border-slate-700 flex justify-between items-center">
                            <span>Khan CRM</span>
                            <button id="langToggle" class="text-xs bg-slate-700 px-2 py-1 rounded">${t('toggleLang')}</button>
                        </div>
                        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                            ${['clients', 'sellers', 'buyers', 'agents', 'properties'].map(sec => `
                                <button onclick="setSection('${sec}')" class="w-full text-left px-4 py-3 rounded-lg transition ${activeSection === sec ? 'bg-blue-600 text-white' : 'hover:bg-slate-800 text-slate-300'}">
                                    ${t(sec)}
                                </button>
                            `).join('')}
                        </nav>
                        <div class="p-4 border-t border-slate-700">
                            <p class="text-xs text-slate-400 mb-2 truncate">${currentUser.uid}</p>
                            <button id="logoutBtn" class="w-full bg-red-500 hover:bg-red-600 py-2 rounded-lg text-sm font-bold transition">
                                ${t('logout')}
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content -->
                    <main class="flex-1 flex flex-col h-screen overflow-hidden">
                        <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold text-slate-800 capitalize">${t(activeSection)}</h2>
                            <button id="addBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                                <span>+</span> ${t('addNew')}
                            </button>
                        </header>
                        <div id="dataList" class="flex-1 overflow-y-auto p-6 space-y-4">
                            <div class="flex items-center justify-center h-32 text-slate-400">${t('loading')}</div>
                        </div>
                    </main>
                </div>

                <!-- Modal Container -->
                <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
                        <h3 id="modalTitle" class="text-lg font-bold mb-4"></h3>
                        <div id="modalContent" class="space-y-4"></div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">${t('cancel')}</button>
                            <button id="modalSubmit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700"></button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('logoutBtn').onclick = () => signOut(auth);
            document.getElementById('addBtn').onclick = () => openForm();
            document.getElementById('langToggle').onclick = () => {
                language = language === 'en' ? 'ur' : 'en';
                renderApp();
                fetchData();
            };
            fetchData();
        };

        // --- Logic ---
        const handleAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth error", e);
            }
        };

        window.setSection = (section) => {
            activeSection = section;
            renderApp();
        };

        const fetchData = () => {
            if (!currentUser) return;
            const collectionPath = `artifacts/${appId}/users/${currentUser.uid}/${activeSection}`;
            const colRef = collection(db, collectionPath);

            onSnapshot(colRef, (snapshot) => {
                const listContainer = document.getElementById('dataList');
                if (!listContainer) return;

                if (snapshot.empty) {
                    listContainer.innerHTML = `<div class="text-center py-10 text-slate-400">${t('noData')}</div>`;
                    return;
                }

                listContainer.innerHTML = '';
                snapshot.forEach((documentSnap) => {
                    const item = documentSnap.data();
                    const id = documentSnap.id;
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center hover:shadow-md transition";
                    card.innerHTML = `
                        <div class="space-y-1">
                            <h4 class="font-bold text-slate-800">${item.name || item.title || 'Untitled'}</h4>
                            <p class="text-sm text-slate-500">${item.phone ? `ðŸ“ž ${item.phone}` : ''}</p>
                            <p class="text-sm text-slate-500">${item.address || ''}</p>
                            ${item.price ? `<p class="text-blue-600 font-bold">${t('price')}: ${item.price}</p>` : ''}
                        </div>
                        <div class="flex gap-2">
                             ${item.phone ? `
                                <a href="https://wa.me/${item.phone.replace(/\D/g,'')}" target="_blank" class="p-2 text-green-600 hover:bg-green-50 rounded-lg">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.025 3.284l-.549 2.012 2.057-.54c.952.518 1.988.814 3.235.814 3.18 0 5.765-2.586 5.766-5.766 0-3.18-2.586-5.77-5.766-5.77zm3.846 8.357c-.147.413-.844.755-1.155.804-.263.041-.61.074-1.748-.396-1.455-.601-2.391-2.074-2.463-2.171-.073-.098-.592-.787-.592-1.503 0-.717.375-1.07.509-1.217.134-.147.294-.184.39-.184l.279.004c.091 0 .213-.034.333.253.123.294.422 1.029.458 1.103.037.073.061.159.012.257-.049.098-.074.159-.147.244-.073.086-.153.191-.219.257-.074.073-.151.153-.065.3.086.147.382.632.82 1.021.564.502 1.039.658 1.187.731.147.073.232.061.319-.037.086-.098.368-.428.466-.575.098-.147.196-.123.331-.074.134.049.856.403.1003.477.147.073.244.11.279.171.037.061.037.354-.109.767z"/></svg>
                                </a>
                             ` : ''}
                            <button onclick="openForm('${id}', ${JSON.stringify(item).replace(/"/g, '&quot;')})" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button onclick="confirmDelete('${id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }, (err) => {
                console.error("Fetch error:", err);
                document.getElementById('dataList').innerHTML = `<div class="text-red-500 p-4 bg-red-50 rounded-lg">Error: ${err.message}</div>`;
            });
        };

        window.openForm = (id = null, data = {}) => {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            const submitBtn = document.getElementById('modalSubmit');

            title.innerText = id ? `${t('edit')} ${t(activeSection)}` : `${t('addNew')} ${t(activeSection)}`;
            submitBtn.innerText = t('save');

            let fields = `
                <div>
                    <label class="block text-sm font-medium text-slate-700">${t('name')}</label>
                    <input type="text" id="fieldName" value="${data.name || ''}" class="mt-1 w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">${t('phone')}</label>
                    <input type="text" id="fieldPhone" value="${data.phone || ''}" placeholder="e.g. 923001234567" class="mt-1 w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">${t('address')}</label>
                    <textarea id="fieldAddress" class="mt-1 w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">${data.address || ''}</textarea>
                </div>
            `;

            if (activeSection === 'properties') {
                fields += `
                    <div>
                        <label class="block text-sm font-medium text-slate-700">${t('price')}</label>
                        <input type="text" id="fieldPrice" value="${data.price || ''}" class="mt-1 w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                `;
            }

            content.innerHTML = fields;
            modal.classList.remove('hidden');

            submitBtn.onclick = async () => {
                const updatedData = {
                    name: document.getElementById('fieldName').value,
                    phone: document.getElementById('fieldPhone').value,
                    address: document.getElementById('fieldAddress').value,
                    updatedAt: new Date().toISOString()
                };
                if (document.getElementById('fieldPrice')) {
                    updatedData.price = document.getElementById('fieldPrice').value;
                }

                try {
                    const path = `artifacts/${appId}/users/${currentUser.uid}/${activeSection}`;
                    if (id) {
                        await updateDoc(doc(db, path, id), updatedData);
                    } else {
                        updatedData.createdAt = new Date().toISOString();
                        await addDoc(collection(db, path), updatedData);
                    }
                    closeModal();
                } catch (e) {
                    alert("Error saving: " + e.message);
                }
            };
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
        };

        window.confirmDelete = async (id) => {
            if (confirm(t('confirmDelete'))) {
                const path = `artifacts/${appId}/users/${currentUser.uid}/${activeSection}`;
                await deleteDoc(doc(db, path, id));
            }
        };

        // --- Auth Observer ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            renderApp();
        });

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        [dir="rtl"] { font-family: 'Noto Sans Arabic', sans-serif; }
    </style>
</head>
<body class="antialiased">
    <div id="root"></div>
</body>
</html>
